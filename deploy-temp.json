{
  "index": "import \"jsr:@supabase/functions-js/edge-runtime.d.ts\";\nimport { createClient } from \"npm:@supabase/supabase-js@2\";\nimport { geocodeAddress } from '../_shared/geocoding.ts';\n\nconst corsHeaders = {\n  \"Access-Control-Allow-Origin\": \"*\",\n  \"Access-Control-Allow-Methods\": \"GET, POST, PUT, DELETE, OPTIONS\",\n  \"Access-Control-Allow-Headers\": \"Content-Type, Authorization, X-Client-Info, Apikey\",\n};\n\ninterface EventRow {\n  id: string;\n  location: string;\n  location_name: string | null;\n  geocoding_attempted: boolean;\n  updated_at: string;\n  profile_id: string;\n  profiles: {\n    user_id: string;\n  };\n}\n\n\nDeno.serve(async (req: Request) => {\n  const sessionId = Math.random().toString(36).substring(7);\n  console.log(`[Enrich:${sessionId}] ========================================`);\n  console.log(`[Enrich:${sessionId}] NEW ENRICHMENT REQUEST`);\n  console.log(`[Enrich:${sessionId}] ========================================`);\n\n  if (req.method === \"OPTIONS\") {\n    return new Response(null, {\n      status: 200,\n      headers: corsHeaders,\n    });\n  }\n\n  try {\n    console.log(`[Enrich:${sessionId}] Environment check:`);\n    console.log(`[Enrich:${sessionId}] - SUPABASE_URL: ${!!Deno.env.get('SUPABASE_URL')}`);\n    console.log(`[Enrich:${sessionId}] - SUPABASE_SERVICE_ROLE_KEY: ${!!Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')}`);\n    console.log(`[Enrich:${sessionId}] - VITE_GOOGLE_MAPS_API_KEY: ${!!Deno.env.get('VITE_GOOGLE_MAPS_API_KEY')}`);\n\n    const supabaseClient = createClient(\n      Deno.env.get('SUPABASE_URL') ?? '',\n      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? '',\n      { auth: { persistSession: false } }\n    );\n\n    const googleMapsApiKey = Deno.env.get('VITE_GOOGLE_MAPS_API_KEY');\n    if (!googleMapsApiKey) {\n      console.error(`[Enrich:${sessionId}] ERROR: Google Maps API key not configured!`);\n      throw new Error('Google Maps API key not configured');\n    }\n\n    const apiKeyMasked = googleMapsApiKey.length >= 8\n      ? `${googleMapsApiKey.substring(0, 4)}...${googleMapsApiKey.substring(googleMapsApiKey.length - 4)}`\n      : '[INVALID_KEY]';\n    console.log(`[Enrich:${sessionId}] Google Maps API key present (masked): ${apiKeyMasked}`);\n\n    const url = new URL(req.url);\n    const batchSize = parseInt(url.searchParams.get('batch_size') || '50');\n    const dryRun = url.searchParams.get('dry_run') === 'true';\n    const recentHours = parseInt(url.searchParams.get('recent_hours') || '24');\n\n    console.log(`[Enrich:${sessionId}] Parameters:`);\n    console.log(`[Enrich:${sessionId}] - batch_size: ${batchSize}`);\n    console.log(`[Enrich:${sessionId}] - dry_run: ${dryRun}`);\n    console.log(`[Enrich:${sessionId}] - recent_hours: ${recentHours}`);\n\n    const recentCutoff = new Date(Date.now() - recentHours * 60 * 60 * 1000).toISOString();\n    console.log(`[Enrich:${sessionId}] Processing events updated after: ${recentCutoff}`);\n\n    let query = supabaseClient\n      .from('events')\n      .select('id, location, location_name, geocoding_attempted, updated_at, profile_id, profiles!inner(user_id)')\n      .not('location', 'is', null)\n      .or('location_name.is.null,location_name.eq.')\n      .eq('geocoding_attempted', false)\n      .gte('updated_at', recentCutoff)\n      .order('updated_at', { ascending: false });\n\n    console.log(`[Enrich:${sessionId}] Query filter: location NOT NULL AND (location_name IS NULL OR location_name = '') AND geocoding_attempted = false AND updated_at >= ${recentCutoff}`);\n\n    console.log(`[Enrich:${sessionId}] Fetching events from database...`);\n    const fetchStart = Date.now();\n    const { data: events, error: fetchError } = await query.limit(batchSize);\n    const fetchTime = Date.now() - fetchStart;\n\n    if (fetchError) {\n      console.error(`[Enrich:${sessionId}] Database fetch error (${fetchTime}ms):`, fetchError);\n      throw fetchError;\n    }\n\n    console.log(`[Enrich:${sessionId}] Fetched ${events?.length || 0} events in ${fetchTime}ms`);\n\n    if (!events || events.length === 0) {\n      console.log(`[Enrich:${sessionId}] No events need enrichment`);\n      return new Response(\n        JSON.stringify({\n          success: true,\n          message: 'No events need location name enrichment',\n          eventsProcessed: 0\n        }),\n        {\n          headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n          status: 200,\n        }\n      );\n    }\n\n    console.log(`[Enrich:${sessionId}] Processing ${events.length} events...`);\n    console.log(`[Enrich:${sessionId}] Sample events:`, events.slice(0, 3).map(e => ({\n      id: e.id,\n      location: e.location,\n      location_name: e.location_name,\n      geocoding_attempted: e.geocoding_attempted\n    })));\n\n    const results = {\n      processed: 0,\n      enriched: 0,\n      cached: 0,\n      failed: 0,\n      skipped: 0,\n      alreadyAttempted: 0\n    };\n\n    for (let i = 0; i < events.length; i++) {\n      const event = events[i];\n      console.log(`[Enrich:${sessionId}] -------- Event ${i + 1}/${events.length} (ID: ${event.id}) --------`);\n\n      try {\n        if (!event.location || event.location.trim() === '') {\n          console.log(`[Enrich:${sessionId}] Event ${event.id}: Empty location, skipping`);\n          results.skipped++;\n          continue;\n        }\n\n        const hasValidLocationName = event.location_name && event.location_name.trim() !== '';\n        console.log(`[Enrich:${sessionId}] Event ${event.id}:`);\n        console.log(`[Enrich:${sessionId}]   - location: \"${event.location}\"`);\n        console.log(`[Enrich:${sessionId}]   - location_name: \"${event.location_name || 'NULL'}\"`);\n        console.log(`[Enrich:${sessionId}]   - geocoding_attempted: ${event.geocoding_attempted}`);\n        console.log(`[Enrich:${sessionId}]   - hasValidLocationName: ${hasValidLocationName}`);\n\n        if (hasValidLocationName) {\n          console.log(`[Enrich:${sessionId}] Event ${event.id}: Already has valid location_name, skipping`);\n          results.skipped++;\n          continue;\n        }\n\n        if (event.geocoding_attempted) {\n          console.log(`[Enrich:${sessionId}] Event ${event.id}: Geocoding already attempted, skipping`);\n          results.alreadyAttempted++;\n          continue;\n        }\n\n        console.log(`[Enrich:${sessionId}] Event ${event.id}: Calling geocode API with three-tier approach...`);\n        const userId = event.profiles?.user_id;\n        const geocodeResult = await geocodeAddress(\n          event.location,\n          googleMapsApiKey,\n          supabaseClient,\n          null,\n          userId,\n          event.id\n        );\n        const locationName = geocodeResult.locationName;\n\n        console.log(`[Enrich:${sessionId}] Event ${event.id}: Geocode returned locationName: \"${locationName}\"`);\n\n        await new Promise(resolve => setTimeout(resolve, 100));\n\n        if (locationName && locationName.trim() !== '') {\n          console.log(`[Enrich:${sessionId}] Event ${event.id}: Valid location name found: \"${locationName}\"`);\n\n          if (!dryRun) {\n            console.log(`[Enrich:${sessionId}] Event ${event.id}: Updating database...`);\n            const updateStart = Date.now();\n            const { error: updateError } = await supabaseClient\n              .from('events')\n              .update({\n                location_name: locationName,\n                geocoding_attempted: true\n              })\n              .eq('id', event.id);\n            const updateTime = Date.now() - updateStart;\n\n            if (updateError) {\n              console.error(`[Enrich:${sessionId}] Event ${event.id}: ✗ Database update failed (${updateTime}ms):`, updateError.message);\n              results.failed++;\n            } else {\n              console.log(`[Enrich:${sessionId}] Event ${event.id}: ✓ Successfully updated (${updateTime}ms)`);\n              console.log(`[Enrich:${sessionId}]   \"${event.location}\" -> \"${locationName}\"`);\n              results.enriched++;\n            }\n          } else {\n            console.log(`[Enrich:${sessionId}] Event ${event.id}: [DRY RUN] Would update with: \"${locationName}\"`);\n            results.enriched++;\n          }\n        } else {\n          console.warn(`[Enrich:${sessionId}] Event ${event.id}: ⚠ No location name found for: \"${event.location}\"`);\n\n          if (!dryRun) {\n            console.log(`[Enrich:${sessionId}] Event ${event.id}: Marking geocoding as attempted to prevent retry...`);\n            const updateStart = Date.now();\n            const { error: updateError } = await supabaseClient\n              .from('events')\n              .update({ geocoding_attempted: true })\n              .eq('id', event.id);\n            const updateTime = Date.now() - updateStart;\n\n            if (updateError) {\n              console.error(`[Enrich:${sessionId}] Event ${event.id}: ✗ Failed to mark geocoding_attempted (${updateTime}ms):`, updateError.message);\n            } else {\n              console.log(`[Enrich:${sessionId}] Event ${event.id}: ✓ Marked as attempted (${updateTime}ms)`);\n            }\n          } else {\n            console.log(`[Enrich:${sessionId}] Event ${event.id}: [DRY RUN] Would mark geocoding_attempted = true`);\n          }\n          results.failed++;\n        }\n\n        results.processed++;\n      } catch (error) {\n        console.error(`[Enrich:${sessionId}] Event ${event.id}: ✗ Exception:`, error);\n        if (error instanceof Error) {\n          console.error(`[Enrich:${sessionId}]   Error message: ${error.message}`);\n          console.error(`[Enrich:${sessionId}]   Error stack:`, error.stack);\n        }\n        results.failed++;\n      }\n    }\n\n    console.log(`[Enrich:${sessionId}] ========================================`);\n    console.log(`[Enrich:${sessionId}] FINAL RESULTS:`);\n    console.log(`[Enrich:${sessionId}]   - Total processed: ${results.processed}`);\n    console.log(`[Enrich:${sessionId}]   - Successfully enriched: ${results.enriched}`);\n    console.log(`[Enrich:${sessionId}]   - Cache hits: ${results.cached}`);\n    console.log(`[Enrich:${sessionId}]   - Skipped: ${results.skipped}`);\n    console.log(`[Enrich:${sessionId}]   - Already attempted: ${results.alreadyAttempted}`);\n    console.log(`[Enrich:${sessionId}]   - Failed: ${results.failed}`);\n    console.log(`[Enrich:${sessionId}] ========================================`);\n\n    return new Response(\n      JSON.stringify({\n        success: true,\n        message: `Processed ${results.processed} events`,\n        results,\n        dryRun\n      }),\n      {\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n        status: 200,\n      }\n    );\n\n  } catch (error) {\n    console.error(`[Enrich:${sessionId}] ========================================`);\n    console.error(`[Enrich:${sessionId}] FATAL ERROR`);\n    console.error(`[Enrich:${sessionId}] ========================================`);\n    console.error(`[Enrich:${sessionId}] Exception:`, error);\n    if (error instanceof Error) {\n      console.error(`[Enrich:${sessionId}] Error message: ${error.message}`);\n      console.error(`[Enrich:${sessionId}] Error stack:`, error.stack);\n    }\n    return new Response(\n      JSON.stringify({\n        success: false,\n        error: error instanceof Error ? error.message : 'An unknown error occurred'\n      }),\n      {\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\n        status: 500,\n      }\n    );\n  }\n});"
}
